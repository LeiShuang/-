package com.zfsoft.zfsoft_product.modules.personal.account_address.add;

import android.os.Bundle;
import android.view.View;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;

import com.hengyi.wheelpicker.listener.OnCityWheelComfirmListener;
import com.hengyi.wheelpicker.ppw.CityWheelPickerPopupWindow;
import com.vondear.rxtool.RxActivityTool;
import com.vondear.rxtool.view.RxToast;
import com.zfsoft.zfsoft_product.R;
import com.zfsoft.zfsoft_product.base.BaseFragment;
import com.zfsoft.zfsoft_product.entity.AddressBean;
import com.zfsoft.zfsoft_product.entity.SignBean;
import com.zfsoft.zfsoft_product.utils.DbHelper;

import java.util.HashMap;
import java.util.Map;

import javax.inject.Inject;

import butterknife.BindView;

/**
 * Created by ckw
 * on 2019/1/19.
 */
public class NewAddAddressFragment extends BaseFragment implements NewAddAddressContract.View {

    @BindView(R.id.rl_back)
    RelativeLayout mRlBack;//返回
    @BindView(R.id.tv_save)
    TextView mTvSave;//保存
    @BindView(R.id.iv_select_address)
    ImageView mIvSelectAddress;
    @BindView(R.id.tv_province)
    TextView mTvProvince;//省份
    @BindView(R.id.tv_city)
    TextView mTvCity;//市
    @BindView(R.id.tv_district)
    TextView mTvDistrict;//区
    @BindView(R.id.et_name)
    EditText mEtName;//收货人姓名
    @BindView(R.id.et_phone)
    EditText mEtPhone;//收货人手机号
    @BindView(R.id.et_address)
    EditText mEtAddress;//详细地址

    private String mProvince;
    private String mCity;
    private String mDistrict;
    private CityWheelPickerPopupWindow wheelPickerPopupWindow;

    private AddressBean mAddressBean;

    @Inject
    NewAddAddressPresenter mNewAddAddressPresenter;

    private Map<String,String> mParams;
    @Inject
    public NewAddAddressFragment() {
    }

    @Override
    protected int getLayoutResID() {
        return R.layout.fragment_new_add_address;
    }

    @Override
    protected void initVariables() {
        mParams = new HashMap<>();
    }

    @Override
    protected void handleBundle(Bundle bundle) {
        mAddressBean = bundle.getParcelable("bean");
    }

    @Override
    protected void operateViews(View view) {
        wheelPickerPopupWindow = new CityWheelPickerPopupWindow(getActivity());

        if(mAddressBean != null){
            mTvProvince.setText(mAddressBean.getSf());
            mTvCity.setText(mAddressBean.getCs());
            mTvDistrict.setText(mAddressBean.getXj());
            mEtAddress.setText(mAddressBean.getXxdz());
            mEtPhone.setText(mAddressBean.getSjh());
            mEtName.setText(mAddressBean.getXm());

            mProvince = mAddressBean.getSf();
            mCity = mAddressBean.getCs();
            mDistrict = mAddressBean.getXj();
        }

    }

    @Override
    protected void initListener() {
        mTvSave.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if(mAddressBean != null){
                    mParams.put("id",String.valueOf(mAddressBean.getId()));
                }
                mParams.put("yhm", DbHelper.getUserId(mContext));
                mParams.put("xm",mEtName.getText().toString().trim());//姓名
                mParams.put("sjh",mEtPhone.getText().toString().trim());//手机号
                mParams.put("sf",mProvince);
                mParams.put("cs",mCity);
                mParams.put("xj",mDistrict);
                mParams.put("xxdz",mEtAddress.getText().toString().trim());
                mNewAddAddressPresenter.addMyAddress(mParams);
            }
        });
        mIvSelectAddress.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                wheelPickerPopupWindow.show();
            }
        });

        wheelPickerPopupWindow.setListener(new OnCityWheelComfirmListener() {
            @Override
            public void onSelected(String Province, String City, String District, String PostCode) {
                if(!Province.isEmpty()){
                    mTvProvince.setText(Province);
                }
                if (!City.isEmpty()) {
                    mTvCity.setText(City);
                }

                if (!District.isEmpty()) {
                    mTvDistrict.setText(District);
                }
                mProvince = Province;
                mCity = City;
                mDistrict = District;
            }
        });

        mRlBack.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                getActivity().finish();
            }
        });

    }

    @Override
    public void initPresenter() {
        mNewAddAddressPresenter.takeView(this);
    }

    @Override
    protected boolean immersionEnabled() {
        return true;
    }

    @Override
    protected void immersionInit() {
        super.immersionInit();
        if (immersionBar == null) {
            return;
        }
        immersionBar.statusBarDarkFont(true);
        immersionBar.statusBarColor(R.color.colorWhite)
                .init();
    }

    @Override
    public void addMyAddressSuccess(SignBean signBean) {
        String msgtype = signBean.getMsgtype();
        if("1".equals(msgtype)){
            RxToast.showToast("提交成功");
            getActivity().setResult(100);
            getActivity().finish();
        }else {
            RxToast.showToast("提交失败");
        }

    }

    @Override
    public void addMyAddressFailure(String errorMsg) {
        RxToast.showToast(errorMsg);
        getActivity().setResult(100);
        getActivity().finish();
    }
}
